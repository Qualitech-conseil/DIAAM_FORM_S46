<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulaire Sondage</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app">
        <img id="client-logo" src="" alt="Logo" style="max-width:150px; display:block; margin:0 auto 20px;" />
        <h1 id="form-title">Chargement...</h1>
        <form id="survey-form"></form>
        <button id="submit-btn" style="display:none; margin-top:20px;">Envoyer</button>
        <p id="status"></p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get("client");

        if (!clientId) {
            document.getElementById("app").innerHTML = "<p>Aucun client spécifié. Ajoutez ?client=xxx dans l'URL.</p>";
        }

        const SUPABASE_URL = "https://vawvmiosgslvykfqxffs.supabase.co"; 
        const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhd3ZtaW9zZ3NsdnlrZnF4ZmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjcxNTAsImV4cCI6MjA3OTU0MzE1MH0.T_q5fT1PCOt_pwEFdoKqePFYp7N4IXZSN1XA3HGG5v8"; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

        async function loadConfig() {
            const response = await fetch(`clients/${clientId}/config.json`);
            if (!response.ok) {
                document.getElementById("app").innerHTML = "<p>Impossible de charger la configuration du client.</p>";
                return;
            }

            const config = await response.json();
            document.getElementById("client-logo").src = config.logo || "";
            document.getElementById("form-title").innerText = config.title || "Sondage";

            const form = document.getElementById("survey-form");
            form.innerHTML = "";

            config.categories.forEach(cat => {
                const block = document.createElement("div");
                block.className = "category-block";

                const q = document.createElement("h3");
                q.innerText = cat.question;
                block.appendChild(q);

                cat.options.forEach(opt => {
                    const line = document.createElement("div");
                    line.innerHTML = `
                        <label>
                            <input type=\"checkbox\" name="${cat.id}" value="${opt}" /> ${opt}
                        </label>
                    `;
                    block.appendChild(line);
                });

                const other = document.createElement("div");
                other.innerHTML = `
                    <label>
                        <input type=\"checkbox\" name="${cat.id}" value="Autre" /> Autre
                    </label>
                    <input type="text" id="other-${cat.id}" placeholder="Précisez" style="display:none;margin-left:10px;" />
                `;

                block.appendChild(other);

                form.appendChild(block);

                form.addEventListener("change", e => {
                    if (e.target.name === cat.id && e.target.value === "Autre") {
                        const otherInput = document.getElementById(`other-${cat.id}`);
                        otherInput.style.display = e.target.checked ? "inline-block" : "none";
                    }
                });
            });

            document.getElementById("submit-btn").style.display = "block";
        }

        async function submitForm() {
            const form = document.getElementById("survey-form");
            const status = document.getElementById("status");
            status.innerText = "";

            const formData = new FormData(form);
            const entries = [];

            for (let [key, value] of formData.entries()) {
                let other = null;
                if (value === "Autre") {
                    other = document.getElementById(`other-${key}`).value;
                }
                entries.push({ key, value, other });
            }

            const grouped = config.categories.map(cat => {
                const selected = entries.filter(e => e.key === cat.id);
                return {
                    category_id: cat.id,
                    question: cat.question,
                    choices: selected.map(s => s.value),
                    other_values: selected.filter(s => s.other).map(s => s.other)
                };
            });

            await supabaseClient.from("responses").insert({
                client: clientId,
                data: grouped
            });

            status.innerText = "Merci, vos réponses ont été enregistrées.";
            document.getElementById("submit-btn").disabled = true;
        }

        document.getElementById("submit-btn").addEventListener("click", submitForm);

        loadConfig();
    </script>
</body>
</html>
